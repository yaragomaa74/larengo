<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Larengo - ØªØªØ¨Ø¹ Ø§Ù„ØµÙ„ÙˆØ§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
 font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ ÙØ§ØªØ­Ø© */
            overflow-x: hidden; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø­ØªÙØ§Ù„Ø§Øª */
            display: flex; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø´ÙƒÙ„ Ø¹Ù…ÙˆØ¯ÙŠ */
            flex-direction: column; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø´ÙƒÙ„ Ø¹Ù…ÙˆØ¯ÙŠ */
            align-items: center; /* Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙÙ‚ÙŠØ§Ù‹ */
            justify-content: flex-start; /* Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø£Ø¹Ù„Ù‰ */
            min-height: 100vh; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ø³Ù… ÙŠØ´ØºÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            margin: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¬Ø³Ù… */
            padding: 4px; /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù‡Ø§Ù…Ø´ Ø¹Ø§Ù… */
            background-image: url('./images/Gemini_Generated_Image_wxc817wxc817wxc8.png');
            background-size: cover; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ØªØºØ·ÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            background-repeat: no-repeat; /* Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© */
            background-position: center center; /* (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø© */
            position: relative; /* Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¹Ù†ØµØ± pseudo-element ::before */
            height: 100vh;
        }
        /* Ø·Ø¨Ù‚Ø© ØªØ±Ø§ÙƒØ¨ Ù„Ù„Ø®Ù„ÙÙŠØ© */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.222); /* ØªØ±Ø§ÙƒØ¨ Ø£Ø³ÙˆØ¯ Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ */
            z-index: -1; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ø®Ù„Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆÙ„ÙƒÙ† ÙÙˆÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© */
        }
        .larengo-title {
            /* ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø£Ù„ÙˆØ§Ù† ØªØ¯Ø±Ø¬ Ù‡Ø§Ø¯Ø¦Ø© Ø¬Ø¯Ø§Ù‹ Ù„ØªØ£Ø«ÙŠØ± "Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨ÙŠØ¶" */
            background: linear-gradient(90deg, #e6eff7, #dbe9f2, #d0e4ee, #c5dde9); /* ØªØ¯Ø±Ø¬ Ù‡Ø§Ø¯Ø¦ Ø¬Ø¯ÙŠØ¯ */
            -webkit-background-clip: text;
            background-clip:text;
            -webkit-text-fill-color: transparent;
            font-size: 4.5rem; /* Ø²ÙŠØ§Ø¯Ø© Ø·ÙÙŠÙØ© ÙÙŠ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
            font-weight: 800; /* Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø®Ø· */
            animation: float-subtle 3s infinite ease-in-out; /* ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø¥Ù„Ù‰ "Ø·ÙÙˆ" Ø®ÙÙŠÙ Ø¬Ø¯ÙŠØ¯ */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1); /* Ø§Ù„Ø¸Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ù†Øµ */
            line-height: 1; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§ÙØ© Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ø¹Ù„Ù‰/Ø£Ø³ÙÙ„ */
            margin-bottom: 2rem; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø§Ø­Ù‚Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ */
        }

        @keyframes float-subtle { /* Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù†ÙˆØ§Ù† */
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); } /* Ø·ÙÙˆ Ø¹Ù…ÙˆØ¯ÙŠ Ø®ÙÙŠÙ */
            100% { transform: translateY(0px); }
        }

        #child-selection-area {
            /* ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø£Ù„ÙˆØ§Ù† ØªØ¯Ø±Ø¬ Ù‡Ø§Ø¯Ø¦Ø© Ø¬Ø¯Ø§Ù‹ Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
            background: linear-gradient(90deg, #e6eff7, #dbe9f2, #d0e4ee, #c5dde9); /* ØªØ¯Ø±Ø¬ Ù‡Ø§Ø¯Ø¦ Ø¬Ø¯ÙŠØ¯ */
            border: none; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ„Ø¨Ø© */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* Ø¸Ù„ Ø£Ø®Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù…Ø¸Ù‡Ø± Ù‡Ø§Ø¯Ø¦ */
        }
        
        #child-selection-area label {
            color: #333333; /* Ù†Øµ Ø£ØºÙ…Ù‚ Ù„ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø®ÙÙŠÙ */
        }

        #child-selection-area input {
            background-color: #ffffff; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø®Ù„ÙÙŠØ© Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ¶Ø§Ø¡ */
            color: #333; /* Ù†Øµ Ø¯Ø§ÙƒÙ† Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        }
        
        #child-selection-area input::placeholder {
            color: #666; /* Ø¶Ø¨Ø· Ù„ÙˆÙ† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø§Ø¦Ø¨ Ù„Ù„Ø±Ø¤ÙŠØ© */
        }

        #child-selection-area p {
            color: #333333; /* Ù†Øµ Ø£ØºÙ…Ù‚ Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
        }

        .prayer-box {
            /* ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù…Ø¸Ù‡Ø± Ø£ÙƒØ«Ø± Ø·ÙÙˆÙ„ÙŠØ© ÙˆØ­Ø¬Ù… Ø£ÙƒØ¨Ø± */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 1.5rem; /* Ø²ÙˆØ§ÙŠØ§ Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¯Ø§Ø±Ø© (Ù…Ø§ ÙŠØ¹Ø§Ø¯Ù„ rounded-3xl) */
            border: 2px solid #a8dadc; /* Ø­Ø¯ÙˆØ¯ Ø²Ø±Ù‚Ø§Ø¡ Ù†Ø§Ø¹Ù…Ø© */
            box-shadow: 0 4px 10px rgba(0, 150, 199, 0.1); /* Ø¸Ù„ Ø£Ø²Ø±Ù‚ Ø£Ù†Ø¹Ù… */
            padding: 2rem; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø© Ù…Ù† p-6 Ø¥Ù„Ù‰ p-8 */
        }
        .prayer-box:hover {
            transform: translateY(-8px); /* Ø±ÙØ¹ Ø·ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
            box-shadow: 0 12px 25px rgba(0, 150, 199, 0.25); /* Ø¸Ù„ Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        }
        .prayer-box.prayed {
            background-color: #d4edda; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ Ù„Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ø¤Ø¯Ø§Ø© */
            border-color: #28a745;
        }
        /* Increased size of emojis inside prayer boxes */
        .prayer-box .text-6xl {
            font-size: 8rem; /* Made emojis much larger */
        }

        /* Container for individual palm tree growth stages */
        #palm-tree-stages-container {
            min-height: 180px; /* Adjust as needed for the largest emoji */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* For absolute positioning of stages if needed */
        }

        .palm-tree-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0; /* Start hidden */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            position: absolute; /* Stack stages on top of each other */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .palm-tree-stage.active {
            opacity: 1; /* Show active stage */
            transform: translateY(0) scale(1);
        }
        .palm-tree-stage.hidden-stage {
            opacity: 0;
            transform: translateY(20px) scale(0.8); /* Fade out and shrink */
            pointer-events: none; /* Prevent interaction with hidden elements */
        }


        .palm-tree-emoji {
            font-size: 4rem; /* Increased base size of palm tree emoji */
            transition: transform 0.3s ease-in-out, color 0.3s ease-in-out, filter 0.3s ease-in-out; /* Smooth transitions */
            display: inline-block; /* Ensure transform works */
            animation: subtleFloatPalm 4s infinite ease-in-out; /* Added gentle float animation */
        }
        /* Specific scale adjustments for palm tree growth applied dynamically */
        .palm-tree-emoji[style*="scale"] {
            transform-origin: bottom center; /* Ensure scaling from the base */
        }


        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„ØªØ±ØªÙŠØ¨ */
        .ranking-list::-webkit-scrollbar,
        .weekly-history-list::-webkit-scrollbar,
        .recent-prayers-list::-webkit-scrollbar,
        .achievements-details-list::-webkit-scrollbar, /* Added for achievements modal */
        .duaa-list::-webkit-scrollbar { /* Added for duaa modal */
            width: 8px;
        }
        .ranking-list::-webkit-scrollbar-track,
        .weekly-history-list::-webkit-scrollbar-track,
        .recent-prayers-list::-webkit-scrollbar-track,
        .achievements-details-list::-webkit-scrollbar-track, /* Added for achievements modal */
        .duaa-list::-webkit-scrollbar-track { /* Added for duaa modal */
            background: #f1f1f1;
            border-radius: 10px;
        }
        .ranking-list::-webkit-scrollbar-thumb,
        .weekly-history-list::-webkit-scrollbar-thumb,
        .recent-prayers-list::-webkit-scrollbar-thumb,
        .achievements-details-list::-webkit-scrollbar-thumb, /* Added for achievements modal */
        .duaa-list::-webkit-scrollbar-thumb { /* Added for duaa modal */
            background: #888;
            border-radius: 10px;
        }
        .ranking-list::-webkit-scrollbar-thumb:hover,
        .weekly-history-list::-webkit-scrollbar-thumb:hover,
        .recent-prayers-list::-webkit-scrollbar-thumb:hover,
        .achievements-details-list::-webkit-scrollbar-thumb:hover, /* Added for achievements modal */
        .duaa-list::-webkit-scrollbar-thumb:hover { /* Added for duaa modal */
            background: #555;
            border-radius: 10px;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø§Ø­ØªÙØ§Ù„ */
        .celebration-particle {
            position: fixed;
            font-size: 2rem;
            opacity: 0;
            animation: fallAndFade 3s forwards ease-out;
            pointer-events: none; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†Ù‚Ø±Ø§Øª Ø¨Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ø®Ù„Ø§Ù„Ù‡ */
            z-index: 1000;
        }

        @keyframes fallAndFade {
            0% {
                transform: translateY(-50px) rotate(0deg);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© */
        @keyframes subtlePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); } /* Ù†Ø¨Ø¶ Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            100% { transform: scale(1); }
        }

        @keyframes subtleFloat {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); } /* Ø·ÙÙˆ Ø±Ø£Ø³ÙŠ Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ */
            100% { transform: translateY(0px); }
        }
        /* New animation for the palm tree icon itself */
        @keyframes subtleFloatPalm {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); } /* More pronounced float for the palm tree */
            100% { transform: translateY(0px); }
        }

        .prayer-emoji-animated {
            display: inline-block; /* Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
            animation: subtleFloat 3s infinite ease-in-out; /* Ø­Ø±ÙƒØ© Ø·ÙÙŠÙØ© Ù…Ø³ØªÙ…Ø±Ø© */
        }

        .prayer-box:hover .prayer-emoji-animated {
            animation: subtlePulse 0.6s ease-in-out; /* Ù†Ø¨Ø¶ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
            animation-iteration-count: 1; /* ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        }

        /* Ø£Ù†Ù…Ø§Ø· Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ù‚ÙÙ„Ø© */
        .prayer-box.locked {
            opacity: 0.5; /* ØªØ¹ØªÙŠÙ…Ù‡Ø§ */
            pointer-events: none; /* Ø¬Ø¹Ù„Ù‡Ø§ ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± */
            cursor: not-allowed;
            filter: grayscale(100%); /* Ø¬Ø¹Ù„Ù‡Ø§ Ø±Ù…Ø§Ø¯ÙŠØ© Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ù…Ù‚ÙÙ„ */
        }
        /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙØ§Ø¡ ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø© */
        .prayer-box.locked:hover {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 150, 199, 0.1);
        }

        /* Ø­Ø§Ù„Ø§Øª Ø´Ø¬Ø±Ø© Ø§Ù„Ù†Ø®ÙŠÙ„ */
        /* Note: 'paler' and 'withered' use filters for visual effect on the original emoji. */
        .palm-tree-emoji.paler {
            filter: grayscale(50%) brightness(1.2); /* Ø¬Ø¹Ù„Ù‡Ø§ Ø´Ø§Ø­Ø¨Ø© */
            color: #8c8c8c; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ù†Ø®Ù„Ø© Ø§Ù„Ø´Ø§Ø­Ø¨Ø© */
        }
        .palm-tree-emoji.withered {
            filter: sepia(100%) saturate(200%) brightness(80%); /* Ø¬Ø¹Ù„Ù‡Ø§ ØªØ¨Ø¯Ùˆ Ø°Ø§Ø¨Ù„Ø©/ØµÙØ±Ø§Ø¡ */
            opacity: 0.7;
            color: #b2e8b2; /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ Ù„Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø°Ø§Ø¨Ù„ */
            font-size: 3.5rem; /* Adjusted for withered leaf */
        }
        .palm-tree-emoji.fruiting {
            filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.6)); /* ØªÙˆÙ‡Ø¬ Ø£Ø®Ø¶Ø± */
            color: #388e3c; /* Ø£Ø®Ø¶Ø± ØºÙ†ÙŠ ÙˆØ­ÙŠÙˆÙŠ */
        }
        .achievement-icon {
            font-size: 2.5rem; /* Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø±Ø§Øª */
            margin: 0 0.5rem;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); /* Ø¸Ù„ Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ */
            transition: transform 0.2s ease-in-out;
        }
        .achievement-icon:hover {
            transform: scale(1.2);
        }

        /* Styles for Achievement/Duaa Details Modals */
        .modal-overlay {
            transition: opacity 0.3s ease-out; /* Fade in/out for the overlay */
            opacity: 0;
        }

        .modal-content-wrapper {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.95); /* Start slightly smaller */
            opacity: 0; /* Start hidden */
            position: relative; /* To contain absolutely positioned decorative elements */
            overflow: hidden; /* Ensure decorative elements don't spill outside */
        }

        .detail-card { /* Renamed from achievement-card to be more generic */
            background-color: #f8f8f8;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            opacity: 0; /* Initial state for animation */
            transform: translateY(20px); /* Initial state for animation */
            animation: fade-in-slide-up 0.5s ease-out forwards; /* Apply base animation */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Added for hover effect */
            cursor: pointer; /* Indicate clickable/hoverable */
        }
        .detail-card:hover { /* New hover effect */
            transform: scale(1.03); /* Slightly enlarge on hover */
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); /* More pronounced shadow */
        }

        .detail-card .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .detail-card .title {
            font-weight: bold;
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 0.25rem;
        }
        .detail-card .description {
            font-size: 0.9rem;
            color: #555;
        }

        /* Keyframes for animations */
        @keyframes fade-in-slide-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes float-element-1 {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(20px, -15px) rotate(10deg); }
            66% { transform: translate(-10px, 10px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes float-element-2 {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-15px, 20px) rotate(-10deg); }
            66% { transform: translate(10px, -10px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes glowing-pulse {
            0% { filter: drop-shadow(0 0 3px rgba(255, 255, 0, 0.4)); opacity: 0.6;}
            50% { filter: drop-shadow(0 0 8px rgba(255, 255, 0, 0.8)); opacity: 0.9;}
            100% { filter: drop-shadow(0 0 3px rgba(255, 255, 0, 0.4)); opacity: 0.6;}
        }

        /* Decorative elements styles */
        .modal-decorative-element {
            position: absolute;
            font-size: 1.5rem; /* Default size for sparkle/bubble */
            opacity: 0; /* Start hidden, will animate in */
            filter: blur(1px); /* Subtle blur */
            pointer-events: none; /* Make them unclickable */
            z-index: 1; /* Below content */
            animation-duration: 6s; /* Longer animation duration */
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            animation-fill-mode: forwards;
        }

        .modal-sparkle {
            animation-name: float-element-1, glowing-pulse;
            color: #FFD700; /* Gold-ish */
        }
        .modal-key-icon {
            animation-name: float-element-2;
            color: #6C7A89; /* Grey-ish for key */
        }
        .modal-bubble {
            animation-name: float-element-1; /* Use float-element-1 for bubbles */
            color: #ADD8E6; /* Light blue */
            filter: blur(2px) opacity(0.7); /* More blur for ethereal look */
        }
        .modal-heart {
            animation-name: float-element-2; /* Use float-element-2 for hearts */
            color: #F08080; /* Light red */
            filter: blur(1.5px) opacity(0.8);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-content flex-start min-h-screen p-4">

    <h1 class="larengo-title">Larengo</h1>

    <!-- Display Active Child Name (replaces user-id-display) -->
    <!-- This section is now hidden as requested -->
    <div id="active-child-info-display" class="text-xl text-gray-800 mb-6 px-4 py-2 bg-white rounded-lg shadow-md hidden">
        Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ù†Ø´Ø·: <span id="displayed-child-name" class="font-bold text-green-700"></span>
    </div>

    <!-- Child Name Input -->
    <div id="child-selection-area" class="p-6 rounded-2xl shadow-xl mb-8 w-full max-w-md text-center">
        <label for="childNameInput" class="block text-lg font-bold mb-4">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„:</label>
        <input type="text" id="childNameInput" class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 mb-4" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯">
        <button id="selectChildBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105">
            Ø§Ø¨Ø¯Ø£ ØªØªØ¨Ø¹ Ø§Ù„ØµÙ„ÙˆØ§Øª
        </button>
        <p id="child-welcome-message" class="font-semibold mt-4 hidden"></p>
    </div>

    <!-- Daily Start Message Area -->
    <div id="daily-start-area" class="p-6 rounded-2xl shadow-xl mb-8 w-full max-w-md text-center bg-white hidden">
        <p id="daily-start-message" class="text-2xl font-bold text-gray-800 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ ØªØ±ÙˆÙŠ Ù†Ø®Ù„ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</p>
        <button id="startDayBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105">
            Ù†Ø¹Ù…ØŒ Ù‡ÙŠØ§ Ø¨Ù†Ø§!
        </button>
    </div>

    <div id="main-app-content" class="w-full max-w-6xl bg-white bg-opacity-80 p-8 rounded-2xl shadow-xl flex flex-col md:flex-row gap-8 hidden">
        <div class="flex-1">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
            <div id="prayer-boxes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            <!-- New section for supplications and achievements buttons -->
            <div class="mt-8 text-center flex justify-center flex-wrap gap-4">
                <button id="show-duaa-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg border border-teal-700 text-lg">
                    Ø£Ø¯Ø¹ÙŠØ© ØªØ«Ø¨ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ğŸ’–
                </button>
                <button id="show-achievements-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105 border border-blue-700 text-lg">
                    ØºØ±ÙØ© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© ğŸ—ï¸
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col gap-8">
            <div class="bg-gray-50 p-8 rounded-2xl shadow-inner text-center">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Ù†Ø®Ù„Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</h3>
                <div id="palm-tree-stages-container" class="relative w-full h-48 mb-4">
                    <!-- Palm tree stages will be dynamically rendered here -->
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                    <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%;"></div>
                </div>
                <p id="palm-tree-message-display" class="text-lg text-gray-600 mt-2">Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ ØµÙ„ÙˆØ§ØªÙƒ!</p>
                <div class="flex justify-center mt-4 flex-wrap gap-4"> <!-- Added gap-4 here -->
                    <button id="show-recent-prayers-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105 border border-purple-700">
                        Ø¹Ø±Ø¶ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
                    </button>
                    <button id="show-weekly-history-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out shadow-md hover:shadow-lg transform hover:scale-105 border border-teal-700">
                        Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
                    </button>
                    <!-- show-achievements-btn was moved from here -->
                </div>
            </div>

            <!-- New: Achievements Display Area -->
            <div class="bg-gray-50 p-8 rounded-2xl shadow-inner text-center">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
                <div id="achievements-display" class="flex flex-wrap justify-center items-center gap-4">
                    <p id="no-achievements-message" class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø¨Ø¹Ø¯.</p>
                </div>
            </div>

            <div class="bg-gray-50 p-8 rounded-2xl shadow-inner flex-1 flex-col flex">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4 text-center">ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµÙ„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø·ÙØ§Ù„)</h3>
                <div id="ranking-list" class="flex-1 overflow-y-auto ranking-list">
                    <p class="text-center text-gray-500">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ø³Ø¬Ù„ÙˆØ§ ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg w-full text-center">
            <p id="modal-message" class="text-xl font-semibold text-gray-800 mb-6 text-center"></p>
            <button id="modal-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-xl transition duration-300 ease-in-out">
                Ø­Ø³Ù†Ø§Ù‹
            </button>
        </div>
    </div>

    <div id="recent-prayers-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-lg w-full modal-content-wrapper">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù„Ù„Ø·ÙÙ„ <span id="current-child-name-display" class="text-blue-600"></span></h3>
            <ul id="recent-prayers-list" class="space-y-3 max-h-80 overflow-y-auto ranking-list">
                </ul>
            <div class="mt-8 text-center">
                <button id="recent-prayers-close-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-xl transition duration-300 ease-in-out">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Weekly History Modal -->
    <div id="weekly-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-xl w-full modal-content-wrapper">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„Ù€ <span id="weekly-history-child-name" class="text-teal-600"></span></h3>
            <div id="weekly-history-list" class="space-y-3 max-h-80 overflow-y-auto ranking-list border rounded p-3">
                <!-- Content will be dynamically generated here -->
            </div>
            <div class="mt-8 text-center">
                <button id="weekly-history-close-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-xl transition duration-300 ease-in-out">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- New: Achievement Details Modal (Secret Room) -->
    <div id="achievements-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-2xl w-full mx-4 modal-content-wrapper">
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">ØºØ±ÙØ© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© ğŸ—ï¸</h3>
            <div id="achievements-details-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto pr-2 achievements-details-list">
                <!-- Achievement cards will be dynamically generated here -->
            </div>
            <div class="mt-8 text-center">
                <button id="achievements-details-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-xl transition duration-300 ease-in-out">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
            <!-- Decorative elements for Secret Room -->
            <span class="modal-decorative-element modal-sparkle" style="top: 10%; left: 5%; animation-delay: 0s;">âœ¨</span>
            <span class="modal-decorative-element modal-sparkle" style="bottom: 15%; right: 10%; animation-delay: 0.5s;">âœ¨</span>
            <span class="modal-decorative-element modal-key-icon" style="top: 5%; right: 20%; animation-delay: 1s;">ğŸ”‘</span>
            <span class="modal-decorative-element modal-key-icon" style="bottom: 25%; left: 20%; animation-delay: 1.5s;">ğŸ—ï¸</span>
            <span class="modal-decorative-element modal-sparkle" style="top: 40%; right: 5%; animation-delay: 2s;">âœ¨</span>
            <span class="modal-decorative-element modal-key-icon" style="bottom: 5%; left: 50%; animation-delay: 2.5s;">ğŸ”‘</span>
        </div>
    </div>

    <!-- New: Duaa Modal -->
    <div id="duaa-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-2xl w-full mx-4 modal-content-wrapper">
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Ø£Ø¯Ø¹ÙŠØ© ØªØ«Ø¨ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ğŸ’–</h3>
            <div id="duaa-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 duaa-list">
                <!-- Duaa cards will be dynamically generated here -->
            </div>
            <div class="mt-8 text-center">
                <button id="duaa-close-btn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-5 rounded-xl transition duration-300 ease-in-out">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
            <!-- Decorative elements for Duaa Modal -->
            <span class="modal-decorative-element modal-bubble" style="top: 10%; left: 80%; animation-delay: 0s;">â˜ï¸</span>
            <span class="modal-decorative-element modal-heart" style="bottom: 5%; right: 70%; animation-delay: 0.7s;">ğŸ’–</span>
            <span class="modal-decorative-element modal-bubble" style="top: 30%; left: 15%; animation-delay: 1.2s;">âœ¨</span>
            <span class="modal-decorative-element modal-heart" style="top: 20%; right: 30%; animation-delay: 1.8s;">ğŸ’•</span>
            <span class="modal-decorative-element modal-bubble" style="bottom: 20%; left: 60%; animation-delay: 2.3s;">â˜ï¸</span>
        </div>
    </div>

    <script type="module">
        // Global Firebase variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBBnKEsZxGjQagNbTTeTt7bDZ3RN_oa21c", 
            authDomain: "larengoapp.firebaseapp.com",
            projectId: "larengoapp",
            storageBucket: "larengoapp.firebasestorage.app",
            messagingSenderId: "654050165355",
            appId: "1:654050165355:web:5a9ea299608ce14db7e72e",
            measurementId: "G-5XZJZPYLFL"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global state variables
        let currentChildName = null;
        let userId = null; // Stores authenticated user ID
        let isAuthReady = false; // Flag indicating authentication completion
        let unsubscribeChildData = null; // To unsubscribe from real-time child data listener
        let unsubscribeRanking = null; // To unsubscribe from real-time ranking listener

        // Reference to the public ranking collection (corrected path for odd segments)
        const publicDailyPrayersRankingRef = collection(db, `artifacts/${appId}/public/data/dailyPrayersRanking`);

        let audioContext;
        let gainNode;

        // Get DOM elements
        const prayerBoxesContainer = document.getElementById('prayer-boxes');
        const childNameInput = document.getElementById('childNameInput');
        const selectChildBtn = document.getElementById('selectChildBtn');
        const childSelectionArea = document.getElementById('child-selection-area'); 
        const dailyStartArea = document.getElementById('daily-start-area');
        const startDayBtn = document.getElementById('startDayBtn');
        const mainAppContent = document.getElementById('main-app-content');
        const childWelcomeMessage = document.getElementById('child-welcome-message'); 
        // Changed palmTreeIcon and palmTreeMessage to palmTreeStagesContainer and palmTreeMessageDisplay
        const palmTreeStagesContainer = document.getElementById('palm-tree-stages-container'); // NEW
        const palmTreeMessageDisplay = document.getElementById('palm-tree-message-display'); // NEW
        const progressBar = document.getElementById('progress-bar'); // NEW

        const rankingList = document.getElementById('ranking-list');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const showRecentPrayersBtn = document.getElementById('show-recent-prayers-btn');
        const recentPrayersModal = document.getElementById('recent-prayers-modal');
        const recentPrayersList = document.getElementById('recent-prayers-list');
        const recentPrayersCloseBtn = document.getElementById('recent-prayers-close-btn');
        const currentChildNameDisplay = document.getElementById('current-child-name-display');

        const activeChildInfoDisplay = document.getElementById('active-child-info-display'); 
        const displayedChildName = document.getElementById('displayed-child-name'); 

        // New DOM elements for weekly history and achievements
        const showWeeklyHistoryBtn = document.getElementById('show-weekly-history-btn');
        const weeklyHistoryModal = document.getElementById('weekly-history-modal');
        const weeklyHistoryList = document.getElementById('weekly-history-list');
        const weeklyHistoryCloseBtn = document.getElementById('weekly-history-close-btn');
        const weeklyHistoryChildNameDisplay = document.getElementById('weekly-history-child-name');
        const achievementsDisplay = document.getElementById('achievements-display');
        const noAchievementsMessage = document.getElementById('no-achievements-message');

        // New DOM elements for Achievement Details Modal (Secret Room)
        const showAchievementsBtn = document.getElementById('show-achievements-btn');
        const achievementsDetailsModal = document.getElementById('achievements-details-modal'); 
        const achievementsDetailsList = document.getElementById('achievements-details-list');
        const achievementsDetailsCloseBtn = document.getElementById('achievements-details-close-btn');

        // New DOM elements for Duaa Modal
        const showDuaaBtn = document.getElementById('show-duaa-btn');
        const duaaModal = document.getElementById('duaa-modal');
        const duaaList = document.getElementById('duaa-list');
        const duaaCloseBtn = document.getElementById('duaa-close-btn');


        // Constants for prayer times and their associated growth stages
        const prayers = [
            { name: "Ø§Ù„ÙØ¬Ø±", id: "fajr", color: "bg-blue-200", emoji: "ğŸŒ…", hour: 3, minute: 10 },
            { name: "Ø§Ù„Ø´Ø±ÙˆÙ‚", id: "shurooq", color: "bg-pink-200", emoji: "ğŸŒ„", hour: 4, minute: 56 },
            { name: "Ø§Ù„Ø¸Ù‡Ø±", id: "dhuhr", color: "bg-yellow-200", emoji: "â˜€ï¸", hour: 11, minute: 58 },
            { name: "Ø§Ù„Ø¹ØµØ±", id: "asr", color: "bg-orange-200", emoji: "ğŸŒ¥ï¸", hour: 15, minute: 33 },
            { name: "Ø§Ù„Ù…ØºØ±Ø¨", id: "maghrib", color: "bg-purple-220", emoji: "ğŸŒ‡", hour: 19, minute: 0 },
            { name: "Ø§Ù„Ø¹Ø´Ø§Ø¡", id: "isha", color: "bg-indigo-200", emoji: "ğŸŒ™", hour: 20, minute: 34 } // Changed emoji from ğŸŒƒ to ğŸŒ™
        ];

        // NEW: Define palm tree growth stages
        const growthStages = [
            { count: 0, emoji: "ğŸŒ±", message: "Ø¨Ø°Ø±Ø© ØªÙ†ØªØ¸Ø± Ø£Ù† ØªÙØ³Ù‚Ù‰!", scale: 0.8 }, // Before Fajr
            { count: 1, emoji: "ğŸŒ¿", message: "Ù†Ø¨ØªØ© ØµØºÙŠØ±Ø© Ø¨Ø¯Ø£Øª ØªÙ†Ù…Ùˆ Ø¨Ø¹Ø¯ ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø±!", scale: 1.0 }, // After Fajr
            { count: 2, emoji: "ğŸŒ¾", message: "Ø§Ù„Ø³Ø§Ù‚ ÙŠÙ†Ù…ÙˆØŒ Ø§Ù„Ù†Ø®Ù„Ø© ØªÙƒØ¨Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±ÙˆÙ‚!", scale: 1.2 }, // After Shurooq
            { count: 3, emoji: "ğŸŒ³", message: "Ø£ÙˆØ±Ø§Ù‚ Ø®Ø¶Ø±Ø§Ø¡ØŒ Ø´Ø¬Ø±Ø© Ù‚ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±!", scale: 1.4 }, // After Dhuhr
            { count: 4, emoji: "ğŸŒ²", message: "Ù†Ø®Ù„Ø© Ø´Ø§Ù…Ø®Ø©ØŒ ØªÙ‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø«Ù…Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ØµØ±!", scale: 1.6 }, // After Asr
            { count: 5, emoji: "ğŸŒ´", message: "Ù†Ø®Ù„Ø© Ù†Ø§Ø¶Ø¬Ø©! Ù…Ø³ØªØ¹Ø¯Ø© Ù„Ù„Ø¹Ø·Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØºØ±Ø¨.", scale: 1.8 }, // After Maghrib
            { count: 6, emoji: "ğŸŸ¤ğŸŒ´", message: "Ù†Ø®Ù„Ø© Ù…Ø«Ù…Ø±Ø© Ø¨Ø§Ù„ØªÙ…ÙˆØ±! Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡.", scale: 2.0 } // After Isha (all 6 prayers)
        ];

        // Function to show a custom message in a popup (for general alerts)
        function showModal(message) {
            if (modalMessage && messageModal) { 
                modalMessage.textContent = message;
                modalMessage.style.textAlign = 'center';
                messageModal.classList.remove('hidden');
            } else {
                console.error("Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡:", message);
                // alert(message); // Using alert is not allowed
            }
        }

        // Initialize AudioContext for sound effects
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0, audioContext.currentTime); // Start with 0 volume
                console.log("ØªÙ… ØªÙ‡ÙŠØ¦Ø© AudioContext.");
            } catch (e) {
                console.error("ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ù„Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­:", e);
            }
        }

        // Play a simple click sound
        function playClickSound() {
            if (!audioContext || audioContext.state === 'suspended') {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log("ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù AudioContext Ø¨Ù†Ø¬Ø§Ø­.");
                        createAndPlayTone();
                    }).catch(e => console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¦Ù†Ø§Ù AudioContext:", e));
                } else {
                    console.warn("Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© AudioContext Ø£Ùˆ ØªÙ… ØªØ¹Ù„ÙŠÙ‚Ù‡. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.");
                }
                return;
            }
            createAndPlayTone();
        }

        function createAndPlayTone() {
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine'; // Simple sine wave
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 tone

            const now = audioContext.currentTime;
            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(0.01, now); // Start with very low volume
            gainNode.gain.linearRampToValueAtTime(0.05, now + 0.01); // Fast attack
            gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.1); // Fast decay

            oscillator.connect(gainNode);
            oscillator.start(now);
            oscillator.stop(now + 0.1); // Play for 0.1 seconds
        }

        // Modal close event handlers (for static message modal)
        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });
        
        // Generic function to open animated modals
        function openAnimatedModal(modalElement) {
            const contentWrapper = modalElement.querySelector('.modal-content-wrapper');
            
            modalElement.classList.remove('hidden'); // Make the overlay visible
            // Force reflow to ensure initial state is applied before transition
            void modalElement.offsetWidth; 
            modalElement.style.opacity = '1';

            // Apply transformed state after a small delay to trigger transition
            setTimeout(() => {
                contentWrapper.style.transform = 'scale(1)';
                contentWrapper.style.opacity = '1';
                // Trigger animation for decorative elements
                const decorativeElements = modalElement.querySelectorAll('.modal-decorative-element');
                decorativeElements.forEach(el => {
                    el.style.animationPlayState = 'running';
                    el.style.opacity = '0.6'; // Fade in decorative elements
                });
            }, 50); // Small delay
        }

        // Generic function to close animated modals
        function closeAnimatedModal(modalElement) {
            const contentWrapper = modalElement.querySelector('.modal-content-wrapper');

            modalElement.style.opacity = '0'; // Start fading out the overlay
            contentWrapper.style.transform = 'scale(0.95)'; // Scale down content
            contentWrapper.style.opacity = '0'; // Fade out content

            // Stop animation for decorative elements
            const decorativeElements = modalElement.querySelectorAll('.modal-decorative-element');
            decorativeElements.forEach(el => {
                el.style.animationPlayState = 'paused';
                el.style.opacity = '0'; // Fade out decorative elements
            });

            modalElement.addEventListener('transitionend', function handler() {
                modalElement.classList.add('hidden'); // Hide completely after transition
                modalElement.removeEventListener('transitionend', handler);
            }, { once: true });
        }

        // Event listeners for closing all animated modals
        recentPrayersCloseBtn.addEventListener('click', () => {
            closeAnimatedModal(recentPrayersModal);
        });

        weeklyHistoryCloseBtn.addEventListener('click', () => {
            closeAnimatedModal(weeklyHistoryModal);
        });

        achievementsDetailsCloseBtn.addEventListener('click', () => {
            closeAnimatedModal(achievementsDetailsModal);
        });
        
        duaaCloseBtn.addEventListener('click', () => {
            closeAnimatedModal(duaaModal);
        });

        // Function to get today's date in 'YYYY-MM-DD' format based on local time
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Check if prayer was performed today
        function checkIfPrayedToday(prayerRecord) {
            if (!prayerRecord || !prayerRecord.timestamp) return false;
            try {
                const prayerDateLocalString = getLocalDateString(new Date(prayerRecord.timestamp));
                const todayLocalString = getLocalDateString();
                return prayerDateLocalString === todayLocalString;
            }
            catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ…ØŒ Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­:", prayerRecord, e);
                return false;
            }
        }

        // Check if all prayers are completed today for the current child
        function checkAllPrayersCompletedToday(lastPrayedMap) {
            return prayers.every(prayer => checkIfPrayedToday(lastPrayedMap[prayer.id]));
        }

        // Trigger celebration animation
        function triggerCelebration() {
            console.log("ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø­ØªÙØ§Ù„!");
            const celebrationContainer = document.createElement('div');
            celebrationContainer.style.position = 'fixed';
            celebrationContainer.style.top = '0';
            celebrationContainer.style.left = '0';
            celebrationContainer.style.width = '100%';
            celebrationContainer.style.height = '100%';
            celebrationContainer.style.overflow = 'hidden';
            celebrationContainer.style.pointerEvents = 'none';
            celebrationContainer.style.zIndex = '1000';

            const particles = ['ğŸ‰', 'âœ¨', 'ğŸŠ', 'ğŸ¥³', 'ğŸŒŸ', 'ğŸ†', 'ğŸ’¯', 'ğŸ¤©'];
            const numberOfParticles = 50;

            for (let i = 0; i < numberOfParticles; i++) {
                const particle = document.createElement('span');
                particle.className = 'celebration-particle';
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.animationDelay = `${Math.random() * 2}s`;
                particle.style.animationDuration = `${2 + Math.random() * 2}s`;
                celebrationContainer.appendChild(particle);
            }

            document.body.appendChild(celebrationContainer);

            setTimeout(() => {
                console.log("Ø¥Ø²Ø§Ù„Ø© Ø¬Ø³ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø­ØªÙØ§Ù„.");
                celebrationContainer.remove();
            }, 5000);
        }

        // Update visual state of palm tree and message based on growth stages
        function updatePalmTree(childData) {
            console.log("ØªØ­Ø¯ÙŠØ« Ø´Ø¬Ø±Ø© Ø§Ù„Ù†Ø®ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„:", childData);
            let prayersCompletedTodayCount = 0;
            let onTimePrayersCount = 0;
            let latePrayersCount = 0;
            const now = new Date();
            const endOfDay = new Date(now);
            endOfDay.setHours(22, 0, 0, 0); // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… 10 Ù…Ø³Ø§Ø¡Ù‹ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©

            if (childData && childData.lastPrayed) {
                prayers.forEach(prayer => {
                    const prayerRecord = childData.lastPrayed[prayer.id];
                    if (checkIfPrayedToday(prayerRecord)) {
                        prayersCompletedTodayCount++;
                        if (prayerRecord.status === 'onTime') {
                            onTimePrayersCount++;
                        } else {
                            latePrayersCount++;
                        }
                    }
                });
            }

            // Determine the current growth stage based on prayersCompletedTodayCount
            let currentStageIndex = 0;
            for (let i = growthStages.length - 1; i >= 0; i--) {
                if (prayersCompletedTodayCount >= growthStages[i].count) {
                    currentStageIndex = i;
                    break;
                }
            }
            const currentGrowthStage = growthStages[currentStageIndex];

            // Clear previous stages and render the current one
            palmTreeStagesContainer.innerHTML = '';
            const stageElement = document.createElement('div');
            stageElement.className = 'palm-tree-stage active';
            stageElement.innerHTML = `
                <span class="palm-tree-emoji" style="transform: scale(${currentGrowthStage.scale})">${currentGrowthStage.emoji}</span>
                <p class="text-lg text-gray-600 mt-2">${currentGrowthStage.message}</p>
            `;
            palmTreeStagesContainer.appendChild(stageElement);

            // Update the message display below the stages
            palmTreeMessageDisplay.textContent = currentGrowthStage.message;


            const allPrayersDone = (prayersCompletedTodayCount === prayers.length);
            const isEndOfDayPassedAndNotAllPrayersDone = (now.getTime() > endOfDay.getTime()) && !allPrayersDone;

            const activeEmojiElement = stageElement.querySelector('.palm-tree-emoji');

            // Apply specific visual states based on conditions to the active emoji
            activeEmojiElement.classList.remove('paler', 'withered', 'fruiting'); // Reset first

            if (isEndOfDayPassedAndNotAllPrayersDone) {
                palmTreeMessageDisplay.textContent = 'ØªØ£Ø®Ø± Ø§Ù„ÙˆÙ‚Øª! Ù†Ø®Ù„ØªÙƒ ØªØ­ØªØ§Ø¬ Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„ÙØ§Ø¦ØªØ©. ğŸ‚';
                activeEmojiElement.classList.add('withered');
                activeEmojiElement.textContent = 'ğŸ‚'; // Change to withered leaf emoji
                activeEmojiElement.style.fontSize = '3.5rem'; // Adjusted for withered leaf
            } else if (allPrayersDone && latePrayersCount === 0) {
                palmTreeMessageDisplay.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„ÙˆØ§Øª ØªÙ…Øª Ø¹Ù„Ù‰ ÙˆÙ‚ØªÙ‡Ø§! Ù†Ø®Ù„ØªÙƒ Ù…Ø²Ù‡Ø±Ø© Ø¨Ø§Ù„Ø«Ù…Ø§Ø±! ğŸ¥­';
                activeEmojiElement.classList.add('fruiting');
                activeEmojiElement.style.color = '#388e3c'; // Rich green for fruiting
                activeEmojiElement.textContent = 'ğŸŸ¤ğŸŒ´'; // Palm tree with dates
            } else if (latePrayersCount > 0) {
                palmTreeMessageDisplay.textContent = 'Ù†Ø®Ù„ØªÙƒ Ù†Ù…ØªØŒ Ù„ÙƒÙ† Ø¨Ø¹Ø¶ Ø§Ù„ØµÙ„ÙˆØ§Øª ÙƒØ§Ù†Øª Ù…ØªØ£Ø®Ø±Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹. ğŸ™';
                activeEmojiElement.classList.add('paler');
                activeEmojiElement.style.color = '#8c8c8c'; // Light greyish for paler
                // Keep the current growth stage emoji, it's already set from currentGrowthStage.emoji
            }

            // Update the progress bar
            const progress = (prayersCompletedTodayCount / prayers.length) * 100;
            progressBar.style.width = `${progress}%`;

            updateAchievementsDisplay(childData);
        }

        // *** Firebase Functions ***

        // Function to fetch child data from Firestore (current user's private collection)
        async function getChildDataFromFirestore(childName) {
            if (!userId) {
                console.error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„.");
                return null;
            }
            if (!childName) {
                console.error("Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firestore.");
                return null;
            }
            try {
                // Path: /artifacts/${appId}/users/${userId}/children/{childName}
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/children`, childName);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„:", docSnap.data());
                    const data = docSnap.data();
                    // Ensure new achievement fields are initialized for existing children
                    if (!data.achievements) data.achievements = {};
                    // Initialize firstPrayerBadge correctly, including the 'earned' property
                    if (typeof data.achievements.firstPrayerBadge === 'undefined' || data.achievements.firstPrayerBadge === null) {
                        data.achievements.firstPrayerBadge = { earned: false, date: null };
                    } else if (typeof data.achievements.firstPrayerBadge.earned === 'undefined') {
                         data.achievements.firstPrayerBadge.earned = false; // Ensure 'earned' property exists
                    }


                    if (!data.achievements.eagleBadges) data.achievements.eagleBadges = { count: 0, lastEarnedDate: null };
                    if (!data.achievements.luminousMedals) data.achievements.luminousMedals = { count: 0, lastEarnedDate: null };
                    if (!data.achievements.goldenPalmSeals) data.achievements.goldenPalmSeals = { count: 0, lastEarnedDate: null };
                    if (!data.dailyStats) data.dailyStats = {};
                    if (typeof data.dailyStats.consecutiveFullDays === 'undefined') data.dailyStats.consecutiveFullDays = 0;
                    if (typeof data.dailyStats.lastFullDayRecordedDate === 'undefined') data.dailyStats.lastFullDayRecordedDate = null;
                    if (typeof data.dailyStats.totalPrayersLoggedOverall === 'undefined') data.dailyStats.totalPrayersLoggedOverall = 0;
                    // Initialize the new flag for the "all prayers completed" message
                    if (typeof data.dailyStats.allPrayersCompletedTodayMessageDisplayed === 'undefined') {
                        data.dailyStats.allPrayersCompletedTodayMessageDisplayed = false;
                    }
                    
                    // Remove old 'streak' if it exists and use 'consecutiveFullDays'
                    if (typeof data.streak !== 'undefined') {
                        delete data.streak;
                    }

                    return data;
                } else {
                    console.log("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ ÙÙŠ Firestore:", childName);
                    // Return initial data if document doesn't exist
                    return {
                        lastPrayed: {},
                        totalPrayers: {},
                        lastActivityDate: null,
                        allLoggedPrayers: [],
                        // New fields for achievements
                        achievements: {
                            firstPrayerBadge: { earned: false, date: null }, // NEW: First Prayer Badge
                            eagleBadges: { count: 0, lastEarnedDate: null },
                            luminousMedals: { count: 0, lastEarnedDate: null },
                            goldenPalmSeals: { count: 0, lastEarnedDate: null }
                        },
                        dailyStats: {
                            consecutiveFullDays: 0,
                            lastFullDayRecordedDate: null,
                            totalPrayersLoggedOverall: 0, // Keep for general count, but Golden Palm uses consecutiveFullDays
                            allPrayersCompletedTodayMessageDisplayed: false // New flag for daily message
                        }
                    };
                }
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø·ÙÙ„:", childName, e);
                showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„.");
                return null;
            }
        }

        // Function to save/update child data in Firestore (current user's private collection)
        async function saveChildDataToFirestore(childName, data) {
            if (!userId) {
                console.error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„.");
                return;
            }
            if (!childName || !data) {
                console.error("Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø­ÙØ¸ ÙÙŠ Firestore.");
                return;
            }
            try {
                // Path: /artifacts/${appId}/users/${userId}/children/{childName}
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/children`, childName);
                await setDoc(docRef, data, { merge: true }); // Use merge: true to update specific fields
                console.log("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€:", childName);
            } catch (e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø·ÙÙ„:", childName, e);
                showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„.");
            }
        }

        // Function to update public ranking data
        async function updatePublicRanking(childName, prayersCompletedTodayCount, userIdOfChild) {
            const todayLocalString = getLocalDateString(); // Use the local date string
            const publicRankDocRef = doc(publicDailyPrayersRankingRef, childName); // Use child name as the ID for the public document
            
            console.log(`[updatePublicRanking] ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ Ù„Ù€: ${childName}, Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙŠÙˆÙ…: ${prayersCompletedTodayCount}, ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ù„ÙŠ: ${todayLocalString}`);

            try {
                // Fetch current public ranking document
                const docSnap = await getDoc(publicRankDocRef);
                let currentPublicData = docSnap.exists() ? docSnap.data() : { prayersToday: 0, lastUpdatedDate: '', userId: userIdOfChild };
                console.log("[updatePublicRanking] Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", currentPublicData);


                // If it's a new day for this child in the public ranking, reset
                if (currentPublicData.lastUpdatedDate !== todayLocalString) {
                    console.log(`[updatePublicRanking] ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${childName}. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.`);
                    currentPublicData.prayersToday = 0;
                    currentPublicData.lastUpdatedDate = todayLocalString;
                    currentPublicData.userId = userIdOfChild; // To track which user added this child
                }

                // Update daily prayer count in public ranking
                currentPublicData.prayersToday = prayersCompletedTodayCount;
                currentPublicData.lastUpdatedDate = todayLocalString; // Confirm date update

                await setDoc(publicRankDocRef, currentPublicData);
                console.log(`[updatePublicRanking] ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ ${childName}. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:`, currentPublicData);
            } catch (e) {
                console.error("[updatePublicRanking] Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ø§Ù…:", childName, e);
            }
        }


        // Real-time listener for current child's data
        function setupChildDataListener(childName) {
            if (unsubscribeChildData) {
                unsubscribeChildData(); // Unsubscribe from previous listener if exists
            }
            if (!userId || !childName) {
                console.warn("[setupChildDataListener] Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ Ù…ÙÙ‚ÙˆØ¯.");
                return;
            }
            
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/children`, childName);
            unsubscribeChildData = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const childData = docSnap.data();
                    console.log("[setupChildDataListener] ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ:", childData);
                    renderPrayerBoxes(childData.lastPrayed);
                    updatePalmTree(childData); // This now also calls updateAchievementsDisplay
                    
                    // Update public ranking immediately upon child data update
                    let prayersCompletedTodayCount = 0;
                    if (childData && childData.lastPrayed) {
                        prayers.forEach(prayer => {
                            if (checkIfPrayedToday(childData.lastPrayed[prayer.id])) {
                                prayersCompletedTodayCount++;
                            }
                        });
                    }
                    console.log(`[setupChildDataListener] Ø¹Ø¯Ø¯ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø§Ù„ÙŠÙˆÙ… Ù„Ù€ ${childName}: ${prayersCompletedTodayCount}`);
                    updatePublicRanking(childName, prayersCompletedTodayCount, userId); // Pass userId of the child
                } else {
                    console.log("[setupChildDataListener] Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù€:", childName);
                    // If document is deleted, reset UI
                    renderPrayerBoxes({});
                    updatePalmTree({});
                    updateAchievementsDisplay({}); // Clear achievements
                }
            }, (error) => {
                console.error("[setupChildDataListener] Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¥Ù„Ù‰ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø·ÙÙ„:", error);
                showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ.");
            });
            console.log(`[setupChildDataListener] ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ù„Ù€ ${childName}.`);
        }

        // Real-time listener for ranking data (all children across users)
        function setupRankingListener() {
            if (unsubscribeRanking) {
                unsubscribeRanking(); // Unsubscribe from previous listener if exists
            }
            if (!isAuthReady) { // Ensure authentication is ready to read from public collection
                console.warn("[setupRankingListener] Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨.");
                return;
            }

            // Listen to the public ranking collection
            unsubscribeRanking = onSnapshot(publicDailyPrayersRankingRef, (querySnapshot) => {
                const rankingDataToday = [];
                const todayLocalString = getLocalDateString(); // Use the local date string
                console.log(`[setupRankingListener] ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„ØªØµÙÙŠØ© Ø§Ù„ØªØ±ØªÙŠØ¨: ${todayLocalString}`);
                console.log(`[setupRankingListener] Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ù„Ù‚Ø·Ø©: ${querySnapshot.docs.length}`);

                querySnapshot.forEach((docSnap) => {
                    const childName = docSnap.id;
                    const publicChildData = docSnap.data();
                    console.log(`[setupRankingListener] Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø³ØªÙ†Ø¯: ${childName}, Ø¨ÙŠØ§Ù†Ø§Øª:`, publicChildData);
                    
                    // Ensure data is for today and has recorded prayers
                    if (publicChildData.lastUpdatedDate === todayLocalString && publicChildData.prayersToday > 0) {
                        rankingDataToday.push({ name: childName, totalPrayerCountToday: publicChildData.prayersToday });
                        console.log(`[setupRankingListener] Ø¥Ø¶Ø§ÙØ© ${childName} Ø¥Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨: ${publicChildData.prayersToday} ØµÙ„Ø§Ø©.`);
                    } else {
                        console.log(`[setupRankingListener] Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ ${childName} Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø¥Ù…Ø§ ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ Ø£Ùˆ 0 ØµÙ„Ø§Ø©).`);
                    }
                });

                // Sort by total prayers for today in descending order
                rankingDataToday.sort((a, b) => b.totalPrayerCountToday - a.totalPrayerCountToday);
                console.log("[setupRankingListener] Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙŠÙˆÙ…:", rankingDataToday);

                rankingList.innerHTML = ''; // Clear previous ranking
                if (rankingDataToday.length === 0) {
                    rankingList.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ø³Ø¬Ù„ÙˆØ§ ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯.</p>';
                } else {
                    rankingDataToday.forEach((item, index) => {
                        const rankingItem = document.createElement('div');
                        rankingItem.className = `flex justify-between items-center p-5 rounded-lg ${index % 2 === 0 ? 'bg-gray-100' : 'bg-white'} shadow-sm mb-2`;
                        rankingItem.innerHTML = `
                            <span class="font-semibold text-lg text-gray-700">${index + 1}. ${item.name}</span>
                            <span class="text-blue-600 font-bold">${item.totalPrayerCountToday} ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ…</span>
                        `;
                        rankingList.appendChild(rankingItem);
                    });
                }
                console.log("[setupRankingListener] ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù… Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ….");
            }, (error) => {
                console.error("[setupRankingListener] Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ø§Ù…Ø©:", error);
                showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ø§Ù….");
            });
            console.log("[setupRankingListener] ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù….");
        }

        // Render prayer boxes
        function renderPrayerBoxes(lastPrayedTimestamps = {}) {
            console.log("Ø¹Ø±Ø¶ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØµÙ„ÙˆØ§Øª:", lastPrayedTimestamps);
            prayerBoxesContainer.innerHTML = ''; // Clear previous boxes

            prayers.forEach((prayer, index) => {
                const isPrayedToday = checkIfPrayedToday(lastPrayedTimestamps[prayer.id]);
                let isLocked = false;
                let clickable = true; // By default, clickable

                if (isPrayedToday) {
                    isLocked = false;
                    clickable = false; // Not clickable again today
                } else {
                    const prevPrayerId = prayers[index - 1]?.id;
                    if (index === 0 || (prevPrayerId && checkIfPrayedToday(lastPrayedTimestamps[prevPrayerId]))) {
                        isLocked = false;
                        clickable = true;
                    } else {
                        isLocked = true;
                        clickable = false;
                    }
                }

                const box = document.createElement('div');
                box.id = `prayer-box-${prayer.id}`;
                box.className = `prayer-box ${prayer.color} p-8 rounded-3xl shadow-md text-center transform hover:scale-105 flex flex-col items-center justify-content center ${isPrayedToday ? 'prayed' : ''} ${isLocked ? 'locked' : ''}`;

                box.innerHTML = `
                    <div class="text-6xl mb-3"><span class="prayer-emoji-animated">${prayer.emoji}</span></div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">${prayer.name}</h3>
                    <p class="text-gray-600 text-sm">${isPrayedToday ? 'ØªÙ…Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ÙŠÙˆÙ… âœ…' : 'Ù„Ù… ØªÙØµÙ„ÙÙ‘ Ø¨Ø¹Ø¯ âŒ'}</p>
                `;

                if (clickable && !isPrayedToday) {
                    box.addEventListener('click', () => markPrayerAsPrayed(prayer.id, prayer.name));
                } else if (isLocked) {
                    box.style.cursor = 'not-allowed';
                }
                prayerBoxesContainer.appendChild(box);
            });
        }

        // Function to update achievements display
        function updateAchievementsDisplay(childData) {
            achievementsDisplay.innerHTML = ''; // Clear previous badges
            let hasAchievements = false;

            if (childData && childData.achievements) {
                const achievements = childData.achievements;
                
                // NEW: First Prayer Badge
                if (achievements.firstPrayerBadge && achievements.firstPrayerBadge.earned) {
                    const firstPrayerBadge = document.createElement('span');
                    firstPrayerBadge.className = 'achievement-icon';
                    firstPrayerBadge.title = `Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù‚Ø© (ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ ${new Date(achievements.firstPrayerBadge.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric'})})`;
                    firstPrayerBadge.textContent = 'âœ¨';
                    achievementsDisplay.appendChild(firstPrayerBadge);
                    hasAchievements = true;
                }

                if (achievements.eagleBadges && achievements.eagleBadges.count > 0) {
                    const eagleBadge = document.createElement('span');
                    eagleBadge.className = 'achievement-icon';
                    eagleBadge.title = `Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø± (ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ ${achievements.eagleBadges.count} Ù…Ø±Ø§Øª)`;
                    eagleBadge.textContent = 'ğŸ¦…';
                    achievementsDisplay.appendChild(eagleBadge);
                    hasAchievements = true;
                }

                if (achievements.luminousMedals && achievements.luminousMedals.count > 0) {
                    const luminousMedal = document.createElement('span');
                    luminousMedal.className = 'achievement-icon';
                    luminousMedal.title = `ÙˆØ³Ø§Ù… Ø§Ù„Ù…ØµÙ„Ù‘ÙŠ Ø§Ù„Ù…Ø¶ÙŠØ¡ (ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ ${achievements.luminousMedals.count} Ù…Ø±Ø§Øª)`;
                    luminousMedal.textContent = 'ğŸŒŸ';
                    achievementsDisplay.appendChild(luminousMedal);
                    hasAchievements = true;
                }

                if (achievements.goldenPalmSeals && achievements.goldenPalmSeals.count > 0) {
                    const goldenPalmSeal = document.createElement('span');
                    goldenPalmSeal.className = 'achievement-icon';
                    goldenPalmSeal.title = `Ø®ØªÙ… Ø§Ù„Ù†Ø®Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© (ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ ${achievements.goldenPalmSeals.count} Ù…Ø±Ø§Øª)`;
                    goldenPalmSeal.textContent = 'ğŸ†';
                    achievementsDisplay.appendChild(goldenPalmSeal);
                    hasAchievements = true;
                }
            }

            if (!hasAchievements) {
                noAchievementsMessage.classList.remove('hidden');
                achievementsDisplay.appendChild(noAchievementsMessage);
            } else {
                noAchievementsMessage.classList.add('hidden');
            }
        }

        // Mark prayer as "prayed" (modified to use Firebase Firestore)
        async function markPrayerAsPrayed(prayerId, prayerName) {
            console.log(`[markPrayerAsPrayed] Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ ØµÙ„Ø§Ø© ${prayerName} Ù„Ù„Ø·ÙÙ„ ${currentChildName}`);
            if (!currentChildName || !userId) {
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
                console.error("[markPrayerAsPrayed] Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø©: Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ Ø£Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ§Ø±Øº.");
                return;
            }

            const now = new Date();
            const todayLocalString = getLocalDateString(now); // Use the local date string
            
            let childData = await getChildDataFromFirestore(currentChildName);
            if (!childData) {
                // getChildDataFromFirestore already handles error
                return;
            }

            const lastPrayedForThisType = childData.lastPrayed[prayerId];
            const alreadyPrayedToday = checkIfPrayedToday(lastPrayedForThisType);

            if (alreadyPrayedToday) {
                showModal(`ØµÙ„Ø§Ø© ${prayerName} ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ Ø§Ù„ÙŠÙˆÙ….`);
                console.warn(`[markPrayerAsPrayed] ØµÙ„Ø§Ø© ${prayerName} Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….`);
                return;
            }

            let prayerStatus = 'onTime';
            const prayerDef = prayers.find(p => p.id === prayerId);
            if (prayerDef) {
                const scheduledPrayerTime = new Date(now);
                scheduledPrayerTime.setHours(prayerDef.hour, prayerDef.minute, 0, 0);

                if (now.getTime() > scheduledPrayerTime.getTime()) {
                    prayerStatus = 'late';
                }
            } else {
                console.error("[markPrayerAsPrayed] ØªØ¹Ø±ÙŠÙ Ø§Ù„ØµÙ„Ø§Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù€:", prayerId);
            }
            
            // Update last prayed time and status for this prayer type
            childData.lastPrayed[prayerId] = {
                timestamp: now.toISOString(),
                status: prayerStatus
            };

            // Update total prayer count for this prayer type
            if (!childData.totalPrayers[prayerId]) {
                childData.totalPrayers[prayerId] = { count: 0, lastPrayed: null };
            }
            childData.totalPrayers[prayerId].count++;
            childData.totalPrayers[prayerId].lastPrayed = now.toISOString();

            // Add prayer to full history log
            childData.allLoggedPrayers.push({
                prayerId: prayerId,
                prayerName: prayerName,
                timestamp: now.toISOString(),
                status: prayerStatus
            });

            // Update overall total prayers logged (for general stats, Golden Palm uses consecutive days now)
            if (!childData.dailyStats) childData.dailyStats = {}; 
            if (typeof childData.dailyStats.totalPrayersLoggedOverall === 'undefined') {
                childData.dailyStats.totalPrayersLoggedOverall = 0;
            }
            childData.dailyStats.totalPrayersLoggedOverall++;

            // Variable to hold the message to show
            let messageToDisplay = null;
            
            // Calculate prayers completed today for the child
            let prayersCompletedTodayCount = 0;
            if (childData && childData.lastPrayed) {
                prayers.forEach(prayer => {
                    if (checkIfPrayedToday(childData.lastPrayed[prayer.id])) {
                        prayersCompletedTodayCount++;
                    }
                });
            }
            console.log(`[markPrayerAsPrayed] Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù„Ù€ ${currentChildName} Ø§Ù„ÙŠÙˆÙ…: ${prayersCompletedTodayCount}`);


            // Check if ALL prayers are completed for TODAY AND it's the 'Isha' prayer
            if (prayersCompletedTodayCount === prayers.length && prayerId === 'isha') {
                // Trigger celebration and show "All prayers completed" message only once per day
                if (!childData.dailyStats.allPrayersCompletedTodayMessageDisplayed) {
                    triggerCelebration(); // <<< Trigger celebration here, specifically on Isha completing the set
                    const completedMessage = `Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…! Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ! ğŸ‰`;
                    messageToDisplay = messageToDisplay ? `${messageToDisplay}\n${completedMessage}` : completedMessage;
                    childData.dailyStats.allPrayersCompletedTodayMessageDisplayed = true; // Mark message as displayed
                }

                // NEW: Check for First Prayer Badge (now only when all prayers are completed, and only once ever)
                // This will be granted only if it's the very first time completing all prayers.
                if (!childData.achievements.firstPrayerBadge.earned) {
                    childData.achievements.firstPrayerBadge.earned = true;
                    childData.achievements.firstPrayerBadge.date = todayLocalString; // Use local date string
                    const firstPrayerBadgeMessage = `ÙŠØ§ Ù„Ù‡ Ù…Ù† Ø¥Ù†Ø¬Ø§Ø²! ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù‚Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ ØµÙ„ÙˆØ§Øª ÙŠÙˆÙ…Ùƒ Ø§Ù„Ø£ÙˆÙ„! âœ¨`;
                    messageToDisplay = messageToDisplay ? `${messageToDisplay}\n${firstPrayerBadgeMessage}` : firstPrayerBadgeMessage;
                }
                
                if (!childData.dailyStats) childData.dailyStats = {};
                if (!childData.achievements) childData.achievements = {};

                // Logic for consecutive full days (streak)
                const lastRecordedFullDayDate = childData.dailyStats.lastFullDayRecordedDate;
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayLocalString = getLocalDateString(yesterday); // Use local date string for yesterday
                console.log(`[markPrayerAsPrayed] lastRecordedFullDayDate: ${lastRecordedFullDayDate}, yesterdayLocalString: ${yesterdayLocalString}, todayLocalString: ${todayLocalString}`);


                if (lastRecordedFullDayDate !== todayLocalString) { // If all prayers completed today for the first time
                    // Check if streak was continued from yesterday
                    if (lastRecordedFullDayDate === yesterdayLocalString) {
                        childData.dailyStats.consecutiveFullDays = (childData.dailyStats.consecutiveFullDays || 0) + 1;
                        console.log(`[markPrayerAsPrayed] Ø³Ù„Ø³Ù„Ø© Ù…ØªØªØ§Ù„ÙŠØ© Ù…Ø³ØªÙ…Ø±Ø©. Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©: ${childData.dailyStats.consecutiveFullDays}`);
                    } else {
                        // Streak broken or new streak start (sets to 1 because today is a full day)
                        childData.dailyStats.consecutiveFullDays = 1;
                        console.log(`[markPrayerAsPrayed] Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø£Øª Ø£Ùˆ Ø§Ù†Ù‚Ø·Ø¹Øª. Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©: ${childData.dailyStats.consecutiveFullDays}`);
                    }
                    childData.dailyStats.lastFullDayRecordedDate = todayLocalString; // Mark today as recorded full day
                }
                
                // Award Eagle Badge (every 3 consecutive full days)
                if (childData.dailyStats.consecutiveFullDays > 0 && childData.dailyStats.consecutiveFullDays % 3 === 0) {
                    if (!childData.achievements.eagleBadges) childData.achievements.eagleBadges = { count: 0, lastEarnedDate: null };
                    // Prevent awarding multiple times on the same day if logic is re-triggered
                    if (childData.achievements.eagleBadges.lastEarnedDate !== todayLocalString) { // Use local date string
                        childData.achievements.eagleBadges.count++;
                        childData.achievements.eagleBadges.lastEarnedDate = todayLocalString; // Use local date string
                        const eagleMessage = `Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø± Ù„Ø¥ÙƒÙ…Ø§Ù„ ${childData.dailyStats.consecutiveFullDays} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©! ğŸ¦…`;
                        messageToDisplay = messageToDisplay ? `${messageToDisplay}\n${eagleMessage}` : eagleMessage;
                        console.log("[markPrayerAsPrayed] ØªÙ… Ù…Ù†Ø­ Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø±.");
                    }
                }

                // Award Luminous Worshipper Medal (every 7 consecutive full days)
                if (childData.dailyStats.consecutiveFullDays > 0 && childData.dailyStats.consecutiveFullDays % 7 === 0) {
                    if (!childData.achievements.luminousMedals) childData.achievements.luminousMedals = { count: 0, lastEarnedDate: null };
                    if (childData.achievements.luminousMedals.lastEarnedDate !== todayLocalString) { // Use local date string
                        childData.achievements.luminousMedals.count++;
                        childData.achievements.luminousMedals.lastEarnedDate = todayLocalString; // Use local date string
                        const luminousMessage = `Ù…Ø¨Ø§Ø±Ùƒ! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ÙˆØ³Ø§Ù… Ø§Ù„Ù…ØµÙ„Ù‘ÙŠ Ø§Ù„Ù…Ø¶ÙŠØ¡ Ù„Ø¥ÙƒÙ…Ø§Ù„ ${childData.dailyStats.consecutiveFullDays} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©! ğŸŒŸ`;
                        messageToDisplay = messageToDisplay ? `${messageToDisplay}\n${luminousMessage}` : luminousMessage;
                        console.log("[markPrayerAsPrayed] ØªÙ… Ù…Ù†Ø­ ÙˆØ³Ø§Ù… Ø§Ù„Ù…ØµÙ„Ù‘ÙŠ Ø§Ù„Ù…Ø¶ÙŠØ¡.");
                    }
                }

                // NEW LOGIC FOR GOLDEN PALM SEAL: every 30 consecutive full days
                if (childData.dailyStats.consecutiveFullDays > 0 && childData.dailyStats.consecutiveFullDays % 30 === 0) {
                    if (!childData.achievements.goldenPalmSeals) childData.achievements.goldenPalmSeals = { count: 0, lastEarnedDate: null };
                    if (childData.achievements.goldenPalmSeals.lastEarnedDate !== todayLocalString) { // Use local date string
                        childData.achievements.goldenPalmSeals.count++;
                        childData.achievements.goldenPalmSeals.lastEarnedDate = todayLocalString; // Use local date string
                        const goldenPalmMessage = `ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø®ØªÙ… Ø§Ù„Ù†Ø®Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ù„Ø¥ÙƒÙ…Ø§Ù„ ${childData.dailyStats.consecutiveFullDays} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©! ğŸ†`;
                        messageToDisplay = messageToDisplay ? `${messageToDisplay}\n${goldenPalmMessage}` : goldenPalmMessage;
                        console.log("[markPrayerAsPrayed] ØªÙ… Ù…Ù†Ø­ Ø®ØªÙ… Ø§Ù„Ù†Ø®Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©.");
                    }
                }
            }


            // Save updated data to Firestore
            await saveChildDataToFirestore(currentChildName, childData);
            
            // Update public ranking after logging prayer
            // This call is crucial for the ranking list
            await updatePublicRanking(currentChildName, prayersCompletedTodayCount, userId);

            // UI updates are handled by the onSnapshot listener for child data (which calls updatePalmTree and updateAchievementsDisplay)
            playClickSound();

            // Show the determined message
            if (messageToDisplay) {
                showModal(messageToDisplay);
            } else {
                // Default message if no other specific message was generated (e.g., intermediate prayer)
                showModal(`Ø£Ø­Ø³Ù†Øª! ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙ„Ø§Ø© ${prayerName}.`);
            }
        }

        // Display recent prayers for current child
        showRecentPrayersBtn.addEventListener('click', async () => {
            if (!currentChildName || !userId) {
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©.');
                return;
            }

            currentChildNameDisplay.textContent = currentChildName;
            recentPrayersList.innerHTML = '<li class="text-center text-gray-500">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>';
            openAnimatedModal(recentPrayersModal);

            const childData = await getChildDataFromFirestore(currentChildName);
            if (!childData || !childData.allLoggedPrayers || childData.allLoggedPrayers.length === 0) {
                recentPrayersList.innerHTML = '<li class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„ÙˆØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ Ø¨Ø¹Ø¯.</li>';
                return;
            }

            // Sort prayers by timestamp in descending order (most recent first)
            const sortedPrayers = [...childData.allLoggedPrayers].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

            recentPrayersList.innerHTML = ''; // Clear loading message

            sortedPrayers.forEach((prayer, index) => {
                const listItem = document.createElement('li');
                const prayerDate = new Date(prayer.timestamp);
                const dateString = prayerDate.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                const timeString = prayerDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                const statusText = prayer.status === 'onTime' ? 'ÙÙŠ Ø§Ù„ÙˆÙ‚Øª' : 'Ù…ØªØ£Ø®Ø±Ø©';
                const statusColor = prayer.status === 'onTime' ? 'text-green-600' : 'text-red-500';

                // Find the prayer definition to get the scheduled time
                const prayerDefinition = prayers.find(p => p.id === prayer.prayerId);
                let scheduledTimeString = '';
                if (prayerDefinition) {
                    // Create a dummy date for formatting the scheduled time
                    const dummyDate = new Date(); // Use any date, we only care about hour/minute
                    dummyDate.setHours(prayerDefinition.hour, prayerDefinition.minute, 0, 0);
                    scheduledTimeString = dummyDate.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                }

                listItem.className = "flex justify-between items-center p-3 rounded-lg bg-gray-50 shadow-sm detail-card"; // Added detail-card for animation
                listItem.style.animationDelay = `${index * 0.05}s`; // Stagger animation
                listItem.innerHTML = `
                    <span class="font-semibold text-gray-700">${prayer.prayerName}</span>
                    <div class="text-sm text-gray-500 text-left">
                        <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ: ${timeString}</p>
                        ${scheduledTimeString ? `<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙÙ‚Ø±Ø±: ${scheduledTimeString}</p>` : ''}
                        <p><span class="${statusColor}">(${statusText})</span></p>
                    </div>
                `;
                recentPrayersList.appendChild(listItem);
            });
        });

        // New function to display weekly prayer history
        showWeeklyHistoryBtn.addEventListener('click', async () => {
            if (!currentChildName || !userId) {
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ.');
                return;
            }

            weeklyHistoryChildNameDisplay.textContent = currentChildName;
            weeklyHistoryList.innerHTML = '<p class="text-center text-gray-500">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
            openAnimatedModal(weeklyHistoryModal);

            const childData = await getChildDataFromFirestore(currentChildName);
            if (!childData || !childData.allLoggedPrayers || childData.allLoggedPrayers.length === 0) {
                weeklyHistoryList.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„ÙˆØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ Ø¨Ø¹Ø¯.</li>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of today

            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6); // Go back 6 days to include today (7 days total)

            // Filter and group prayers by date
            const dailyPrayersStatus = {}; // { 'YYYY-MM-DD': { prayerId: true/false, ... } }

            // Initialize all days in the last 7 with all prayers as not prayed
            for (let i = 0; i < 7; i++) {
                const date = new Date(sevenDaysAgo);
                date.setDate(sevenDaysAgo.getDate() + i);
                const dateKey = getLocalDateString(date); // Use local date string
                dailyPrayersStatus[dateKey] = {};
                prayers.forEach(prayer => {
                    dailyPrayersStatus[dateKey][prayer.id] = false; // Initialize as not prayed
                });
            }

            // Populate with actual prayed data
            childData.allLoggedPrayers.forEach(prayerRecord => {
                const prayerDate = new Date(prayerRecord.timestamp);
                const dateKey = getLocalDateString(prayerDate); // Use local date string for recorded prayer
                // Only consider prayers that happened on or after sevenDaysAgo
                if (dailyPrayersStatus[dateKey] && prayerDate.getTime() >= sevenDaysAgo.getTime()) { 
                     dailyPrayersStatus[dateKey][prayerRecord.prayerId] = true;
                }
            });

            weeklyHistoryList.innerHTML = ''; // Clear loading message

            let hasHistoryInLast7Days = false;
            let cardIndex = 0; // For staggering animation
            // Generate history for the last 7 days (including today)
            for (let i = 0; i < 7; i++) {
                const date = new Date(sevenDaysAgo);
                date.setDate(sevenDaysAgo.getDate() + i);
                const dateKey = getLocalDateString(date); // Use local date string
                
                const displayDate = date.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const isCurrentDay = getLocalDateString(date) === getLocalDateString(today); // Compare using local date string
                
                const dateHeader = document.createElement('div');
                dateHeader.className = `font-bold text-lg p-2 rounded-md mb-2 ${isCurrentDay ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700'} detail-card`;
                dateHeader.style.animationDelay = `${cardIndex++ * 0.05}s`;
                dateHeader.textContent = isCurrentDay ? `Ø§Ù„ÙŠÙˆÙ…: ${displayDate}` : displayDate;
                weeklyHistoryList.appendChild(dateHeader);

                const prayersForDay = dailyPrayersStatus[dateKey] || {};
                
                const dayContainer = document.createElement('div');
                dayContainer.className = 'grid grid-cols-3 sm:grid-cols-6 gap-2 mb-4';
                let anyPrayerOnThisDay = false;

                prayers.forEach(prayer => {
                    const prayed = prayersForDay[prayer.id];
                    const prayerStatusIcon = prayed ? 'âœ…' : 'âŒ';
                    const prayerStatusColor = prayed ? 'text-green-600' : 'text-red-500';

                    const prayerItem = document.createElement('div');
                    prayerItem.className = `flex flex-col items-center p-2 rounded-md text-sm ${prayed ? 'bg-green-50' : 'bg-red-50'} border ${prayed ? 'border-green-200' : 'border-red-200'} detail-card`; // Added detail-card for animation
                    prayerItem.style.animationDelay = `${cardIndex++ * 0.05}s`; // Stagger animation
                    prayerItem.innerHTML = `
                        <span class="text-xl">${prayer.emoji}</span>
                        <span class="font-semibold text-gray-700">${prayer.name}</span>
                        <span class="${prayerStatusColor} text-xs">${prayerStatusIcon}</span>
                    `;
                    dayContainer.appendChild(prayerItem);
                    if (prayed) anyPrayerOnThisDay = true;
                });
                weeklyHistoryList.appendChild(dayContainer);
                if (anyPrayerOnThisDay) hasHistoryInLast7Days = true;
            }

            if (!hasHistoryInLast7Days && childData.allLoggedPrayers.length > 0) {
                 weeklyHistoryList.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„ÙˆØ§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„.</p>';
            } else if (childData.allLoggedPrayers.length === 0) {
                 weeklyHistoryList.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„ÙˆØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ Ø¨Ø¹Ø¯.</p>';
            }
        });

        // Event listener for selecting a child
        selectChildBtn.addEventListener('click', async () => {
            const enteredChildName = childNameInput.value.trim();
            if (!enteredChildName) {
                showModal('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            if (!isAuthReady) { // Ensure authentication is ready before proceeding
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….');
                return;
            }

            currentChildName = enteredChildName;
            localStorage.setItem('larengoCurrentChild', currentChildName); // Save to LocalStorage for persistence
            childWelcomeMessage.textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${currentChildName}!`;
            childWelcomeMessage.classList.remove('hidden');
            
            // Set up real-time listener for the selected child's data
            setupChildDataListener(currentChildName);

            // Removed display of active child info from header
            // activeChildInfoDisplay.classList.remove('hidden');
            // displayedChildName.textContent = currentChildName;

            childSelectionArea.classList.add('hidden');
            dailyStartArea.classList.remove('hidden');
            
            // Initial data load (handled by onSnapshot after listener setup)
            // No need to call getChildDataFromFirestore here directly for UI updates
            // as onSnapshot will will trigger the first update.
        });

        // Event listener for starting the day
        startDayBtn.addEventListener('click', async () => {
            if (!currentChildName || !userId) {
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            const now = new Date();
            const todayLocalString = getLocalDateString(now); // Use the local date string

            let childData = await getChildDataFromFirestore(currentChildName);
            if (!childData) return; // Error handled by getChildDataFromFirestore

            // Initialize dailyStats if it doesn't exist
            if (!childData.dailyStats) {
                childData.dailyStats = {
                    consecutiveFullDays: 0,
                    lastFullDayRecordedDate: null,
                    totalPrayersLoggedOverall: 0,
                    allPrayersCompletedTodayMessageDisplayed: false // Initialize here for new child
                };
            }

            if (childData.lastActivityDate !== todayLocalString) { // Compare using local date string
                // If the day hasn't started for this child, reset prayers
                // Check if yesterday was a full prayer day to continue the streak
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayLocalString = getLocalDateString(yesterday); // Use local date string

                // If last recorded full day was not yesterday, reset consecutiveFullDays
                if (childData.dailyStats.lastFullDayRecordedDate !== yesterdayLocalString) { // Compare using local date string
                    childData.dailyStats.consecutiveFullDays = 0;
                }
                
                // Reset daily prayer status
                childData.lastActivityDate = todayLocalString; // Use local date string
                childData.lastPrayed = {}; // Reset prayers for the new day
                childData.dailyStats.allPrayersCompletedTodayMessageDisplayed = false; // Reset for new day
                
                // Changed the message here as requested
                showModal(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${currentChildName}! Ø±Ø¨ÙÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£Ù† ÙŠØ³Ù…Ø¹ Ø¯Ø¹ÙˆØ§ØªÙƒ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø©. ğŸ¤²`);
                console.log("[startDayBtn] Ø¨Ø¯Ø£ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø·ÙÙ„:", currentChildName);

                // When a new day starts, reset the child's daily prayer count in public ranking
                await updatePublicRanking(currentChildName, 0, userId); // Send 0 prayers for the new day
            } else {
                // If the day has already started
                showModal(`Ù„Ù‚Ø¯ Ø¨Ø¯Ø£Øª ÙŠÙˆÙ…Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ ÙŠØ§ ${currentChildName}!`);
                console.log("[startDayBtn] Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù„Ø·ÙÙ„:", currentChildName);
            }
            
            // Save updated child data (especially dailyStats)
            await saveChildDataToFirestore(currentChildName, childData);

            dailyStartArea.classList.add('hidden');
            mainAppContent.classList.remove('hidden');
            // UI updates (renderPrayerBoxes, updatePalmTree) ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø³ØªÙ…Ø¹ onSnapshot.
        });

        // Achievement Definitions for the Secret Room
        const achievementDefinitions = [
            {
                icon: 'âœ¨',
                title: 'Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´Ø±Ù‚Ø©',
                description: 'ØªÙÙ…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø±Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªÙÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ… Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚. Ø¥Ù†Ù‡Ø§ Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø±Ø§Ø¦Ø¹Ø© ÙÙŠ Ø±Ø­Ù„ØªÙƒ Ù…Ø¹ Ø§Ù„ØµÙ„Ø§Ø©!'
            },
            {
                icon: 'ğŸ¦…',
                title: 'Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø±',
                description: 'ØªÙÙ…Ù†Ø­ Ø¹Ù†Ø¯Ù…Ø§ ØªÙÙƒÙ…Ù„ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³Ø© (Ø§Ù„ÙØ¬Ø±ØŒ Ø§Ù„Ø¸Ù‡Ø±ØŒ Ø§Ù„Ø¹ØµØ±ØŒ Ø§Ù„Ù…ØºØ±Ø¨ØŒ Ø§Ù„Ø¹Ø´Ø§Ø¡) Ù„Ù…Ø¯Ø© 3 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©. Ø£Ù†Øª Ù‚ÙˆÙŠ ÙˆÙ…Ø«Ø§Ø¨Ø± ÙƒØ§Ù„Ù†Ø³Ø±!'
            },
            {
                icon: 'ğŸŒŸ',
                title: 'ÙˆØ³Ø§Ù… Ø§Ù„Ù…ØµÙ„Ù‘ÙŠ Ø§Ù„Ù…Ø¶ÙŠØ¡',
                description: 'ØªÙÙ…Ù†Ø­ Ø¹Ù†Ø¯Ù…Ø§ ØªÙÙƒÙ…Ù„ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³Ø© (Ø§Ù„ÙØ¬Ø±ØŒ Ø§Ù„Ø¸Ù‡Ø±ØŒ Ø§Ù„Ø¹ØµØ±ØŒ Ø§Ù„Ù…ØºØ±Ø¨ØŒ Ø§Ù„Ø¹Ø´Ø§Ø¡) Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ© (Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„)! Ø£Ù†Øª Ù†Ø¬Ù… Ø³Ø§Ø·Ø¹ ÙÙŠ ØµÙ„Ø§ØªÙƒ.'
            },
            {
                icon: 'ğŸ†',
                title: 'Ø®ØªÙ… Ø§Ù„Ù†Ø®Ù„Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©',
                description: 'ØªÙÙ…Ù†Ø­ Ø¹Ù†Ø¯Ù…Ø§ ØªÙÙƒÙ…Ù„ Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³Ø© (Ø§Ù„ÙØ¬Ø±ØŒ Ø§Ù„Ø¸Ù‡Ø±ØŒ Ø§Ù„Ø¹ØµØ±ØŒ Ø§Ù„Ù…ØºØ±Ø¨ØŒ Ø§Ù„Ø¹Ø´Ø§Ø¡) Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…Ù‹Ø§ Ù…ØªØªØ§Ù„ÙŠÙ‹Ø§ (Ø´Ù‡Ø± ÙƒØ§Ù…Ù„)! Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø±Ø© ØªØ«Ø¨Øª Ø£Ù†Ùƒ Ø¨Ø·Ù„ Ø§Ù„ØµÙ„Ø§Ø©ØŒ ÙˆÙ†Ø®Ù„ØªÙƒ ØªØ«Ù…Ø± Ø°Ù‡Ø¨Ø§Ù‹.'
            }
        ];

        // Function to populate and show the Achievements Details Modal
        showAchievementsBtn.addEventListener('click', () => {
            achievementsDetailsList.innerHTML = ''; // Clear previous content

            achievementDefinitions.forEach((achievement, index) => {
                const card = document.createElement('div');
                card.className = 'detail-card'; // Use generic detail-card class
                card.style.animationDelay = `${index * 0.1}s`; // Stagger animation
                card.innerHTML = `
                    <span class="icon">${achievement.icon}</span>
                    <h4 class="title">${achievement.title}</h4>
                    <p class="description">${achievement.description}</p>
                `;
                achievementsDetailsList.appendChild(card);
            });

            openAnimatedModal(achievementsDetailsModal);
        });

        // Duaa Definitions for the Duaa Modal
        const duaaDefinitions = [
            {
                icon: 'ğŸ’–',
                title: 'Ø¯Ø¹Ø§Ø¡ Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø©',
                text: 'Ø§Ù„Ù„Ù‡Ù… Ø§Ø¬Ø¹Ù„ Ø§Ù„ØµÙ„Ø§Ø© Ù‚Ø±Ø© Ø¹ÙŠÙ†ÙŠØŒ ÙˆØ§Ø¬Ø¹Ù„Ù‡Ø§ Ø£Ø­Ø¨ Ø¥Ù„ÙŠ Ù…Ù† ÙƒÙ„ Ø´ÙŠØ¡. Ø³Ø§Ø¹Ø¯Ù†ÙŠ ÙŠØ§ Ø±Ø¨ Ù„Ø£Ø­Ø¨ ØµÙ„Ø§ØªÙŠ ÙˆØ£Ø³ØªÙ…ØªØ¹ Ø¨Ù‡Ø§!'
            },
            {
                icon: 'ğŸ’¡',
                title: 'Ø¯Ø¹Ø§Ø¡ ØªØ°ÙƒØ± Ø§Ù„ØµÙ„Ø§Ø©',
                text: 'ÙŠØ§ Ø§Ù„Ù„Ù‡ØŒ Ø°ÙƒØ±Ù†ÙŠ Ø¨ØµÙ„Ø§ØªÙŠ ÙÙŠ ÙƒÙ„ ÙˆÙ‚ØªØŒ ÙˆØ§Ø¬Ø¹Ù„Ù†ÙŠ Ø£Ø³Ù…Ø¹ Ø§Ù„Ø£Ø°Ø§Ù† Ø¨ÙØ±Ø­ØŒ ÙˆØ£Ø³Ø±Ø¹ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ù‚Ù„Ø¨Ù Ø³Ø¹ÙŠØ¯.'
            },
            {
                icon: 'ğŸŒ³',
                title: 'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø«Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø©',
                text: 'ÙŠØ§ Ø±Ø¨ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„ØµÙ„Ø§Ø© Ù†ÙˆØ±Ù‹Ø§ ÙÙŠ Ù‚Ù„Ø¨ÙŠØŒ ÙˆÙ‚ÙˆØ© ÙÙŠ ÙŠÙˆÙ…ÙŠØŒ ÙˆØ³Ø¹Ø§Ø¯Ø© ÙÙŠ Ø­ÙŠØ§ØªÙŠ. Ø«Ø¨ØªÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ø¬Ø¹Ù„Ù†ÙŠ Ù…Ù† Ø¹Ø¨Ø§Ø¯Ùƒ Ø§Ù„ØµØ§Ù„Ø­ÙŠÙ†.'
            },
            {
                icon: 'âœ¨',
                title: 'Ø¯Ø¹Ø§Ø¡ Ø§Ù„Ø®Ø´ÙˆØ¹ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø©',
                text: 'ÙŠØ§ Ø±Ø¨ØŒ Ø§Ø¬Ø¹Ù„ ØµÙ„Ø§ØªÙŠ ÙƒÙ„Ù‡Ø§ Ø®Ø´ÙˆØ¹ ÙˆØ·Ù…Ø£Ù†ÙŠÙ†Ø©ØŒ ÙˆØ§Ø¬Ø¹Ù„Ù†ÙŠ Ø£Ø´Ø¹Ø± Ø¨Ù‚Ø±Ø¨Ùƒ ÙÙŠ ÙƒÙ„ Ø±ÙƒØ¹Ø© ÙˆØ³Ø¬Ø¯Ø©. ØªÙ‚Ø¨Ù„ ØµÙ„Ø§ØªÙŠ ÙŠØ§ Ø£ÙƒØ±Ù… Ø§Ù„Ø£ÙƒØ±Ù…ÙŠÙ†.'
            }
        ];

        // Function to populate and show the Duaa Modal
        showDuaaBtn.addEventListener('click', () => {
            duaaList.innerHTML = ''; // Clear previous content

            duaaDefinitions.forEach((duaa, index) => {
                const card = document.createElement('div');
                card.className = 'detail-card'; // Use generic detail-card class
                card.style.animationDelay = `${index * 0.1}s`; // Stagger animation
                card.innerHTML = `
                    <span class="icon">${duaa.icon}</span>
                    <h4 class="title">${duaa.title}</h4>
                    <p class="description">${duaa.text}</p>
                `;
                duaaList.appendChild(card);
            });

            openAnimatedModal(duaaModal);
        });


        // Initialize audio on window load
        window.onload = function () {
            initAudio();
        };

        // --- Firebase Authentication and Initial Load ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                console.log("Ù…ØµØ§Ø¯Ù‚Ø© Firebase Ø¬Ø§Ù‡Ø²Ø©. Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", userId);

                // Set up global real-time listeners only after authentication is ready
                setupRankingListener(); // This now listens to the public ranking collection
                
                // Check for previously selected child and load their data
                const savedChildName = localStorage.getItem('larengoCurrentChild');
                if (savedChildName) {
                    childNameInput.value = savedChildName;
                    currentChildName = savedChildName;
                    childWelcomeMessage.textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ÙŠØ§ ${currentChildName}!`;
                    childWelcomeMessage.classList.remove('hidden');

                    // Set up listener for the pre-selected child
                    setupChildDataListener(currentChildName);

                    // Removed display of active child info from header as requested
                    // activeChildInfoDisplay.classList.remove('hidden');
                    // displayedChildName.textContent = currentChildName;

                    childSelectionArea.classList.add('hidden');
                    dailyStartArea.classList.remove('hidden'); // Show daily start area
                }
                // If no child saved, keep child selection area visible.
            } else {
                // User is signed out. Sign in anonymously.
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙˆÙƒÙ† Ù…Ø®ØµØµ.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ù…Ø¬Ù‡ÙˆÙ„.");
                    }
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
                    showModal("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                }
            }
        });
    </script> 
        <!-- Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
<audio id="introMusic" src="sounds/mixkit-funny-melody-audio-logo-2984_2.mp3"></audio>

<!-- ØµÙˆØª Ø§Ù„Ø£Ø¬Ø±Ø§Ø³ -->
<audio id="cartoonBells" src="sounds/mixkit-kids-cartoon-close-bells-2256.mp3"></audio>

<!-- ØµÙˆØª Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
<audio id="welcomeVoice" src="sounds/welcome to larengo (online-audio-converter.com).mp3"></audio>

<!-- ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
<audio id="backgroundMusic" src="sounds/mixkit-funny-melody-audio-logo-2984_2.mp3" autoplay loop></audio>
</body>
</html>

